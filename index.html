<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë”°ë¼ì½ëŠ” êµ¬êµ¬ë‹¨ (2ë‹¨)</title>
    
    <!-- 1. ì‚¬ìš´ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ (Tone.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <!-- 2. ìœ ì•„ìš© í°íŠ¸ (Google Fonts) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&display=swap" rel="stylesheet">

    <!-- 3. CSS ìŠ¤íƒ€ì¼ (ìœ ì•„ìš© ë””ìì¸) -->
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        :root {
            --font-family: 'Gaegu', cursive; /* ì†ê¸€ì”¨ í°íŠ¸ */
            --bg-color: #fffbeb; /* ë”°ëœ»í•œ ë…¸ë€ìƒ‰ ë°°ê²½ */
            --card-bg: #ffffff;
            --text-color: #44403c;
            --primary-color: #22c55e; /* Green (Success) */
            --secondary-color: #3b82f6; /* Blue (Problem) */
            --danger-color: #ef4444; /* Red (Danger) */
            --warning-color: #f97316; /* Orange (Read Aloud) */
            --light-gray: #f1f5f9;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --shadow-press: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: var(--text-color);
            /* ê¸€ì”¨ê°€ ëœ ê¹¨ì ¸ë³´ì´ê²Œ */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ê²Œì„ê¸° ëª¨ì–‘ì˜ ì•± ì»¨í…Œì´ë„ˆ */
        .game-container {
            width: 90%;
            max-width: 340px; /* ì¡°ê¸ˆ ë” ë„“ê²Œ */
            background-color: var(--card-bg);
            border-radius: 24px; /* ë” ë‘¥ê¸€ê²Œ */
            box-shadow: 0 12px 35px var(--shadow-color);
            border: 2px solid #ffffff;
            padding: 2rem;
            box-sizing: border-box;
        }

        /* ìƒë‹¨ ì œëª© */
        h1 {
            font-size: 2rem; /* í°íŠ¸ê°€ ê·€ì—¬ìš°ë‹ˆ í¬ê²Œ */
            font-weight: 700;
            color: var(--text-color);
            margin: 0 0 1rem 0;
            text-align: center;
        }

        /* ë¬¸ì œ í‘œì‹œ ì˜ì—­ */
        .display {
            background-color: #fafafa;
            border: 2px solid #f4f4f5;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
            min-height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.75rem; /* ë¬¸ì œ í°íŠ¸ í¬ê²Œ */
            font-weight: 700;
            color: var(--secondary-color);
            letter-spacing: 2px;
            transition: all 0.2s ease-in-out;
        }

        #problem-text {
            color: var(--text-color);
        }
        
        #answer-text {
            min-width: 60px;
            display: inline-block;
        }

        /* í”¼ë“œë°± íš¨ê³¼ (ë¶€ë“œëŸ¬ìš´ í…Œë‘ë¦¬ ê°•ì¡°) */
        .display.correct {
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }
        .display.incorrect {
            border-color: var(--danger-color);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        /* ìˆ«ì í‚¤íŒ¨ë“œ */
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
            margin-bottom: 1rem;
        }

        /* ìº”ë””/ë¸”ë¡ ê°™ì€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .keypad button {
            font-family: var(--font-family);
            font-size: 2rem;
            font-weight: 700;
            padding: 1.25rem 0;
            border: none;
            border-radius: 16px; /* ë‘¥ê·¼ ë²„íŠ¼ */
            background-color: var(--light-gray);
            color: #334155;
            cursor: pointer;
            
            /* 3D ë²„íŠ¼ íš¨ê³¼ */
            border-bottom: 4px solid #d1d5db; 
            transition: all 0.1s ease-in-out;
        }

        .keypad button:active {
            /* ëˆŒë €ì„ ë•Œ */
            border-bottom-width: 0;
            transform: translateY(4px);
            background-color: #e5e7eb;
        }

        /* 'ì§€ìš°ê¸°' ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .keypad .btn-clear {
            grid-column: 2 / 4;
            background-color: #fee2e2; /* í•‘í¬ */
            color: var(--danger-color);
            border-bottom-color: #fca5a5;
            font-size: 1.5rem;
        }
        .keypad .btn-clear:active {
            background-color: #fecaca;
        }

        /* 2ë‹¨ ë¶ˆëŸ¬ì£¼ê¸° ë²„íŠ¼ */
        .read-aloud-btn {
            width: 100%;
            padding: 1.25rem 0;
            font-family: var(--font-family);
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            background-color: var(--warning-color); /* ì£¼í™©ìƒ‰ */
            border: none;
            border-radius: 16px;
            cursor: pointer;
            
            /* 3D ë²„íŠ¼ íš¨ê³¼ */
            border-bottom: 4px solid #fb923c;
            transition: all 0.1s ease-in-out;
        }
        
        .read-aloud-btn:active {
            border-bottom-width: 0;
            transform: translateY(4px);
            background-color: #fb923c;
        }

        .read-aloud-btn:disabled {
            background-color: #d1d5db;
            border-bottom-color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.7;
        }

    </style>
</head>
<body>

    <!-- 2. HTML êµ¬ì¡° (ë™ì¼) -->
    <div class="game-container">
        <h1>ğŸµë”°ë¼ì½ëŠ” êµ¬êµ¬ë‹¨ (2ë‹¨)</h1>

        <div class="display" id="display-panel">
            <span id="problem-text">2 X 1 = </span>
            <span id="answer-text">?</span>
        </div>

        <div class="keypad" id="keypad">
            <button class="num-btn" data-num="1">1</button>
            <button class="num-btn" data-num="2">2</button>
            <button class="num-btn" data-num="3">3</button>
            <button class="num-btn" data-num="4">4</button>
            <button class="num-btn" data-num="5">5</button>
            <button class="num-btn" data-num="6">6</button>
            <button class="num-btn" data-num="7">7</button>
            <button class="num-btn" data-num="8">8</button>
            <button class="num-btn" data-num="9">9</button>
            <button class="num-btn btn-zero" data-num="0">0</button>
            <button class="btn-clear" id="clear-btn">ì§€ìš°ê¸°</button>
        </div>

        <button class="read-aloud-btn" id="read-btn">
            2ë‹¨ ë¶ˆëŸ¬ì£¼ê¸°
        </button>
    </div>

    <!-- 4. JavaScript (ì‚¬ìš´ë“œ ê¸°ëŠ¥ ëŒ€í­ ì¶”ê°€) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. í•„ìš”í•œ HTML ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
            const problemText = document.getElementById('problem-text');
            const answerText = document.getElementById('answer-text');
            const displayPanel = document.getElementById('display-panel');
            const keypad = document.getElementById('keypad');
            const clearButton = document.getElementById('clear-btn');
            const readButton = document.getElementById('read-btn');
            
            // --- 2. ì‚¬ìš´ë“œ ë° TTS ì„¤ì • ---
            const synth = window.speechSynthesis;
            
            // "ëµë™" (ì •ë‹µ) ì‚¬ìš´ë“œ
            const successSound = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 }
            }).toDestination();
            
            let isAudioReady = false; // ì‚¬ìš©ìê°€ í´ë¦­í•´ì•¼ ì˜¤ë””ì˜¤ ì‹œì‘ ê°€ëŠ¥
            let koVoice = null; // í•œêµ­ì–´ ëª©ì†Œë¦¬
            
            // ë¸Œë¼ìš°ì €ê°€ ëª©ì†Œë¦¬ë¥¼ ë¡œë“œí•˜ë©´ ì‹¤í–‰
            synth.onvoiceschanged = () => {
                const voices = synth.getVoices();
                // 'Yuna' (Windows)ë‚˜ 'Google í•œêµ­ì˜'ê°€ ì•„ë‹Œ ë‹¤ë¥¸ ëª©ì†Œë¦¬ ìš°ì„  íƒìƒ‰
                koVoice = voices.find(v => v.lang === 'ko-KR' && v.name.includes('Google') === false);
                koVoice = koVoice || voices.find(v => v.lang === 'ko-KR'); // ì—†ìœ¼ë©´ ì•„ë¬´ í•œêµ­ì–´ ëª©ì†Œë¦¬
            };
            // (í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ í•œë²ˆ ë” í˜¸ì¶œ)
            koVoice = synth.getVoices().find(v => v.lang === 'ko-KR');

            // --- 3. ê²Œì„ ìƒíƒœ ë³€ìˆ˜ ---
            const currentDan = 2;
            let currentStep = 1;
            let currentAnswer = 2;
            let userInput = "";
            
            // --- 4. í•µì‹¬ í•¨ìˆ˜ ---
            
            // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì‹œì‘ (í•„ìˆ˜)
            async function startAudio() {
                if (!isAudioReady) {
                    await Tone.start();
                    console.log('Audio Context Started');
                    isAudioReady = true;
                }
            }

            // ìŒì„± ì¬ìƒ í—¬í¼ í•¨ìˆ˜
            function speak(text, pitch = 1.4, rate = 1.1, interrupt = true) { // ê¸°ë³¸ pitchë¥¼ 1.3 -> 1.4ë¡œ ìƒí–¥
                startAudio(); // ì˜¤ë””ì˜¤ê°€ ì‹œì‘ ì•ˆëìœ¼ë©´ ì‹œì‘
                if (interrupt) {
                    synth.cancel(); // ì´ì „ ë§ ëŠê¸°
                }
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR';
                utterance.pitch = pitch; // í†¤ ë†’ê²Œ
                utterance.rate = rate; // ì¡°ê¸ˆ ë¹ ë¥´ê²Œ
                
                if (koVoice) {
                    utterance.voice = koVoice;
                }
                
                synth.speak(utterance);
            }

            // ìƒˆ ë¬¸ì œ ë¡œë“œ
            function loadProblem() {
                userInput = "";
                currentAnswer = currentDan * currentStep;
                problemText.textContent = `${currentDan} X ${currentStep} = `;
                answerText.textContent = "?";
                answerText.style.color = 'var(--secondary-color)';
            }

            // í”¼ë“œë°± (ì‹œê°)
            function showFeedback(type) {
                displayPanel.classList.add(type);
                setTimeout(() => {
                    displayPanel.classList.remove(type);
                }, 500);
            }

            // ì •ë‹µ í™•ì¸
            function checkAnswer() {
                const userNum = parseInt(userInput, 10);

                if (userNum === currentAnswer) {
                    // --- 1. ì •ë‹µì¼ ê²½ìš° ---
                    showFeedback('correct');
                    successSound.triggerAttackRelease("C5", "8n"); // "ëµ"
                    setTimeout(() => successSound.triggerAttackRelease("G5", "8n"), 150); // "ë™"
                    
                    answerText.textContent = currentAnswer;
                    answerText.style.color = 'var(--primary-color)';
                    currentStep++;

                    if (currentStep > 9) {
                        // --- 1-1. 9ë‹¨ê¹Œì§€ ëª¨ë‘ ë§íŒ ê²½ìš° ---
                        currentStep = 1;
                        // "ì™€ìš°!" ì¶•í•˜ ë©”ì‹œì§€ (1.5ì´ˆ ë’¤)
                        setTimeout(() => {
                            speak("ì™€ìš°! ì˜í–ˆì–´! ìµœê³ ì•¼!", 1.3, 1); // pitch 1.2 -> 1.3
                        }, 1500);
                    }
                    
                    // ë‹¤ìŒ ë¬¸ì œ (2ì´ˆ ë’¤)
                    setTimeout(loadProblem, 2000);

                } else if (userInput.length >= String(currentAnswer).length) {
                    // --- 2. ì˜¤ë‹µì¼ ê²½ìš° ---
                    showFeedback('incorrect');
                    speak("í•œë²ˆ ë”", 1.3, 1); // "ë‹¤ì‹œ í•œë²ˆ í•´ë³´ì" -> "í•œë²ˆ ë”" (pitch 1.2 -> 1.3)
                    
                    answerText.style.color = 'var(--danger-color)';
                    
                    // 1.5ì´ˆ ë’¤ ì…ë ¥ ì´ˆê¸°í™”
                    setTimeout(() => {
                        userInput = "";
                        answerText.textContent = "?";
                        answerText.style.color = 'var(--secondary-color)';
                    }, 1500);
                }
            }
            
            // 2ë‹¨ ë¶ˆëŸ¬ì£¼ê¸° í•¨ìˆ˜ (íì‰ ë°©ì‹ ìœ ì§€)
            function readAloud() {
                startAudio(); // ì˜¤ë””ì˜¤ ì‹œì‘
                
                if (synth.speaking) {
                    synth.cancel();
                    readButton.textContent = "2ë‹¨ ë¶ˆëŸ¬ì£¼ê¸°";
                    readButton.disabled = false;
                    return;
                }
                
                let utteranceQueue = [];
                for (let i = 1; i <= 9; i++) {
                    const text = `ì´ ${i}ì€ ${currentDan * i}`;
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ko-KR';
                    utterance.rate = 1.0; // ë¶ˆëŸ¬ì£¼ê¸°ëŠ” ë³´í†µ ì†ë„
                    utterance.pitch = 1.2; // í†¤ë§Œ ë†’ê²Œ
                    if (koVoice) utterance.voice = koVoice;
                    
                    // íì— ì¶”ê°€
                    utteranceQueue.push(utterance);
                }
                
                // ë§ˆì§€ë§‰ ìŒì„±ì´ ëë‚˜ë©´ ë²„íŠ¼ ë³µêµ¬
                utteranceQueue[utteranceQueue.length - 1].onend = () => {
                    readButton.textContent = "2ë‹¨ ë¶ˆëŸ¬ì£¼ê¸°";
                    readButton.disabled = false;
                };

                readButton.textContent = "ğŸ”Š ì½ëŠ” ì¤‘... (ì¤‘ì§€)";
                readButton.disabled = false; // ì¤‘ì§€í•  ìˆ˜ ìˆë„ë¡ í™œì„±í™”
                
                // íì— ìˆëŠ” ëª¨ë“  ìŒì„± ìˆœì°¨ì ìœ¼ë¡œ ì¬ìƒ
                utteranceQueue.forEach(u => synth.speak(u));
            }


            // --- 5. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---

            // í‚¤íŒ¨ë“œ (ì´ë²¤íŠ¸ ìœ„ì„)
            keypad.addEventListener('click', async (event) => {
                await startAudio(); // ì²« í´ë¦­ ì‹œ ì˜¤ë””ì˜¤ í™œì„±í™”
                
                if (event.target.classList.contains('num-btn')) {
                    const num = event.target.dataset.num;
                    
                    // ìŒì„±ìœ¼ë¡œ ìˆ«ì ì½ì–´ì£¼ê¸°
                    speak(num, 1.5, 1.2); // í†¤/ì†ë„ ë” ë†’ê²Œ (ìœ ì§€)
                    
                    if (userInput.length >= String(currentAnswer).length) {
                        return;
                    }
                    
                    userInput += num;
                    answerText.textContent = userInput;
                    answerText.style.color = 'var(--text-color)';
                    
                    checkAnswer();
                }
            });

            // ì§€ìš°ê¸° ë²„íŠ¼
            clearButton.addEventListener('click', () => {
                startAudio();
                userInput = "";
                answerText.textContent = "?";
                answerText.style.color = 'var(--secondary-color)';
            });

            // 2ë‹¨ ë¶ˆëŸ¬ì£¼ê¸° ë²„íŠ¼
            readButton.addEventListener('click', readAloud);

            // --- 6. ê²Œì„ ì‹œì‘ ---
            loadProblem();

        });
    </script>

</body>
</html>

